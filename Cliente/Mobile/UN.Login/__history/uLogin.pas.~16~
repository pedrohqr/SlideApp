unit uLogin;

interface

uses
  System.SysUtils, System.Types, System.UITypes, System.Classes, System.Variants, 
  FMX.Types, FMX.Graphics, FMX.Controls, FMX.Forms, FMX.Dialogs, FMX.StdCtrls,
  uBase, FMX.Controls.Presentation, FMX.Edit, FMX.Layouts, Data.DBXDataSnap,
  Data.DBXCommon, IPPeerClient, Data.DB, Data.SqlExpr;

type
  TFrm_Login = class(TFormBase)
    Edt_Username: TEdit;
    LayoutCenter: TLayout;
    Edt_Password: TEdit;
    btn_sign_in: TButton;
    lbl_username: TLabel;
    lbl_password: TLabel;
    AniIndicator: TAniIndicator;
    procedure btn_sign_inClick(Sender: TObject);
  private
    { Private declarations }
  public
    { Public declarations }
  end;

var
  Frm_Login: TFrm_Login;

implementation

{$R *.fmx}

uses uHome, uMain, DS_Functions;

procedure TFrm_Login.btn_sign_inClick(Sender: TObject);
begin
  inherited;
  AniIndicator.Enabled := True;
  TThread.CreateAnonymousThread(procedure
  var
   Conn : TLoginClient;
  begin
    Conn := TLoginClient.Create(DSConn.DBXConnection);
    try
      try
        ID_User := Conn.Auth_Login(Trim(Edt_Username.Text), Trim(Edt_Password.Text));

        TThread.Synchronize(nil, procedure
        begin
          AniIndicator.Enabled := False;
          if ID_User <> 0 then
          begin
            OpenForm(TFrm_Home);
          end
          else
            raise Exception.Create('Nome de usuário ou senha inválidos!');
        end);
      except
        on e : Exception do
        TThread.Synchronize(nil, procedure
        begin
          AniIndicator.Enabled := False;
          ShowMessage(e.Message);
        end);
      end;

    finally
      FreeAndNil(Conn);
    end;

  end).Start;
end;

end.
